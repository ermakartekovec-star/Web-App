<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Genius AI System | Веб-панель управления</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63);
            color: var(--light);
            min-height: 100vh;
        }

        /* Loading Screen */
        #loadingScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--success);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auth Screen */
        #authScreen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--success), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-warning {
            background: rgba(248, 150, 30, 0.15);
            border-left: 4px solid var(--warning);
        }

        /* Main App */
        #mainApp {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--success), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo-text p {
            font-size: 0.9rem;
            color: #aaa;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: var(--border-radius);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            border-radius: 6px;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: rgba(67, 97, 238, 0.2);
            color: white;
        }

        /* Panels */
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .panel.active {
            display: block;
        }

        .panel h2 {
            margin-bottom: 20px;
            color: white;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table th {
            color: #aaa;
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-item h3 {
            margin-bottom: 10px;
            color: white;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(6, 214, 160, 0.2);
            color: #06d6a0;
        }

        .status-offline {
            background: rgba(247, 37, 133, 0.2);
            color: #f72585;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 0.9rem;
        }

        /* AI Chat */
        .ai-chat {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ai-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .ai-input-group input {
            flex: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <h2>Загрузка E-Genius AI System...</h2>
        <p>Подключение к Google Drive</p>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">
                <h1>E-Genius AI System</h1>
                <p style="color: #aaa;">Веб-панель управления</p>
            </div>
            
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i>
                <div>Используются те же пароли, что и в Telegram боте</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Имя пользователя</label>
                <input type="text" class="form-input" id="username" placeholder="admin / platon / guest">
            </div>
            
            <div class="form-group">
                <label class="form-label">Пароль</label>
                <input type="password" class="form-input" id="password" placeholder="Пароль из config.json">
            </div>
            
            <button class="btn btn-primary btn-block" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Войти
            </button>
            
            <div style="margin-top: 20px; text-align: center; color: #aaa; font-size: 0.9rem;">
                <p>Гостям не требуется пароль</p>
                <p>Данные загружаются из Google Drive</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <i class="fas fa-bolt" style="font-size: 2rem; color: #4cc9f0;"></i>
                    <div class="logo-text">
                        <h1>E-Genius AI System</h1>
                        <p id="userGreeting">Панель управления</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <h3 id="userName">Администратор</h3>
                        <p id="userRole">Роль: Админ</p>
                    </div>
                    <button class="btn btn-outline" id="logoutBtn" style="border: 1px solid rgba(255,255,255,0.2); color: white; background: transparent;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-panel="dashboard"><i class="fas fa-tachometer-alt"></i> Дашборд</button>
                <button class="nav-tab" data-panel="ai"><i class="fas fa-robot"></i> ИИ-помощник</button>
                <button class="nav-tab" data-panel="pc"><i class="fas fa-desktop"></i> Управление ПК</button>
                <button class="nav-tab" data-panel="emails"><i class="fas fa-envelope"></i> Email</button>
                <button class="nav-tab" data-panel="broadcast"><i class="fas fa-bullhorn"></i> Рассылки</button>
                <button class="nav-tab" data-panel="chats"><i class="fas fa-comments"></i> Чаты</button>
                <button class="nav-tab" data-panel="platon"><i class="fas fa-user-shield"></i> Платон</button>
                <button class="nav-tab" data-panel="settings"><i class="fas fa-cog"></i> Настройки</button>
                <button class="nav-tab" data-panel="ermak"><i class="fas fa-globe"></i> ERMAK APP</button>
            </div>

            <!-- Panels -->
            <div class="panel active" id="panel-dashboard">
                <h2><i class="fas fa-tachometer-alt"></i> Дашборд системы</h2>
                <div class="cards-grid" id="dashboardCards">
                    <!-- Динамически заполнится -->
                </div>
                
                <div style="margin-top: 30px;">
                    <h3>Статус системы</h3>
                    <div class="cards-grid">
                        <div class="card-item">
                            <h3>Google Drive</h3>
                            <p id="driveStatus">Проверка подключения...</p>
                        </div>
                        <div class="card-item">
                            <h3>Telegram Bot</h3>
                            <p id="botStatus">Загрузка статуса...</p>
                        </div>
                        <div class="card-item">
                            <h3>OpenRouter API</h3>
                            <p id="aiStatus">Проверка доступности...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-ai">
                <h2><i class="fas fa-robot"></i> ИИ-помощник</h2>
                <div class="ai-chat">
                    <div style="margin-bottom: 15px; color: #aaa;">
                        <p>Модель: allenai/molmo-2-8b:free</p>
                        <p>Безлимитное использование для всех пользователей</p>
                    </div>
                    <input type="text" class="form-input" id="aiQuestion" placeholder="Задайте вопрос... (Enter для отправки)">
                    <div class="ai-input-group">
                        <button class="btn btn-primary" id="askAiBtn">
                            <i class="fas fa-paper-plane"></i> Спросить
                        </button>
                        <button class="btn btn-outline" id="clearAiBtn">
                            <i class="fas fa-trash"></i> Очистить
                        </button>
                    </div>
                </div>
                <div id="aiResponse" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; min-height: 100px;">
                    <p style="color: #aaa; text-align: center;">Ответ от ИИ появится здесь</p>
                </div>
            </div>

            <div class="panel" id="panel-pc">
                <h2><i class="fas fa-desktop"></i> Управление ПК</h2>
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-outline" id="refreshPcsBtn">
                        <i class="fas fa-sync-alt"></i> Обновить список
                    </button>
                    <button class="btn btn-outline" id="checkScreenshotsBtn">
                        <i class="fas fa-camera"></i> Проверить скриншоты
                    </button>
                </div>
                <div class="cards-grid" id="pcCards">
                    <!-- Динамически заполнится реальными ПК -->
                </div>
                <div style="margin-top: 20px; text-align: center; color: #aaa;">
                    <p>Данные загружаются из Google Drive (файл pc_status.json)</p>
                </div>
            </div>

            <div class="panel" id="panel-emails">
                <h2><i class="fas fa-envelope"></i> Управление Email</h2>
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="addEmailBtn">
                        <i class="fas fa-plus"></i> Добавить email
                    </button>
                    <button class="btn btn-outline" id="refreshEmailsBtn">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>ID Пользователя</th>
                                <th>Дата добавления</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="emailsTable">
                            <!-- Заполнится динамически -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel" id="panel-broadcast">
                <h2><i class="fas fa-bullhorn"></i> Рассылки</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div class="card-item">
                        <h3>Telegram рассылка</h3>
                        <textarea class="form-input" id="tgBroadcastMessage" style="height: 100px; margin-bottom: 10px;" placeholder="Сообщение для Telegram..."></textarea>
                        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 10px;">Получателей: <span id="tgUsersCount">0</span></p>
                        <button class="btn btn-primary" id="sendTgBroadcastBtn">
                            <i class="fab fa-telegram"></i> Отправить
                        </button>
                    </div>
                    <div class="card-item">
                        <h3>Email рассылка</h3>
                        <textarea class="form-input" id="emailBroadcastMessage" style="height: 100px; margin-bottom: 10px;" placeholder="Сообщение для Email..."></textarea>
                        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 10px;">Получателей: <span id="emailUsersCount">0</span></p>
                        <button class="btn btn-primary" id="sendEmailBroadcastBtn">
                            <i class="fas fa-envelope"></i> Отправить
                        </button>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-chats">
                <h2><i class="fas fa-comments"></i> Мои чаты и каналы</h2>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>ID Чата</th>
                                <th>Username</th>
                                <th>Тип</th>
                            </tr>
                        </thead>
                        <tbody id="chatsTable">
                            <!-- Заполнится из chats.db -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel" id="panel-platon">
                <h2><i class="fas fa-user-shield"></i> Управление Платоном</h2>
                <div class="card-item">
                    <h3>Отправить сообщение Платону</h3>
                    <textarea class="form-input" id="platonMessage" style="height: 100px; margin-bottom: 10px;" placeholder="Сообщение для пользователя Платон..."></textarea>
                    <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 10px;">Активных пользователей Платон: <span id="platonUsersCount">0</span></p>
                    <button class="btn btn-primary" id="sendToPlatonBtn">
                        <i class="fas fa-paper-plane"></i> Отправить
                    </button>
                </div>
            </div>

            <div class="panel" id="panel-settings">
                <h2><i class="fas fa-cog"></i> Настройки системы</h2>
                <div class="card-item">
                    <h3>Системная информация</h3>
                    <p id="systemInfo">Загрузка информации...</p>
                </div>
                <div class="card-item" style="margin-top: 20px;">
                    <h3>Автоответ в канале</h3>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <label style="color: #ccc;">Включен:</label>
                        <input type="checkbox" id="autoReplyToggle">
                        <span id="autoReplyStatus" style="color: #aaa;">Выкл</span>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-ermak">
                <h2><i class="fas fa-globe"></i> ERMAK APP</h2>
                <div class="card-item" style="text-align: center;">
                    <h3>Открыть веб-приложение ERMAK</h3>
                    <p style="margin: 20px 0; color: #aaa;">Доступно для всех пользователей системы</p>
                    <button class="btn btn-primary" id="openErmakBtn" style="padding: 15px 30px; font-size: 1.1rem;">
                        <i class="fas fa-external-link-alt"></i> Открыть ERMAK APP
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <p>© 2026-2028 E-Genius AI System. Все права защищены.</p>
                <p style="margin-top: 10px; font-size: 0.8rem;">
                    <i class="fas fa-cloud"></i> Все данные хранятся в Google Drive | 
                    <i class="fas fa-bolt"></i> Полная синхронизация с Telegram ботом
                </p>
            </footer>
        </div>
    </div>

    <script>
        // ========== КОНСТАНТЫ И КОНФИГУРАЦИЯ ==========
        const CONFIG = {
            FOLDER_NAME: "E-Genius AI System",
            FILES: {
                CONFIG: "config.json",
                AUTH_USERS: "auth_users.json",
                EMAILS: "emails.json",
                PC_STATUS: "pc_status.json",
                PC_COMMANDS: "pc_commands.json",
                SETTINGS: "settings.json",
                CHATS_DB: "chats.db"
            }
        };

        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        let currentUser = null;
        let gapiInitialized = false;
        let folderId = null;
        let configData = null;

        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            try {
                // Показываем экран загрузки
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // 1. Инициализируем Google API
                await initializeGoogleApi();
                
                // 2. Загружаем конфигурацию из Google Drive
                await loadConfigFromDrive();
                
                // 3. Проверяем существующую сессию
                await checkSession();
                
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                showError('Ошибка подключения к Google Drive');
                showAuthScreen();
            }
        }

        // ========== GOOGLE DRIVE API ==========
        async function initializeGoogleApi() {
            return new Promise((resolve, reject) => {
                gapi.load('client:auth2', async () => {
                    try {
                        // Для веб-приложения нам нужен только доступ к файлам
                        await gapi.client.init({
                            apiKey: '',
                            clientId: '',
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly'
                        });
                        
                        gapiInitialized = true;
                        console.log('✅ Google Drive API инициализирован');
                        resolve();
                    } catch (error) {
                        console.error('❌ Ошибка инициализации Google Drive:', error);
                        reject(error);
                    }
                });
            });
        }

        async function loadConfigFromDrive() {
            try {
                // Ищем папку приложения
                const folder = await findOrCreateFolder(CONFIG.FOLDER_NAME);
                folderId = folder.id;
                console.log('✅ Папка найдена:', folderId);
                
                // Загружаем конфигурацию
                const configFile = await findFile(CONFIG.FILES.CONFIG, folderId);
                if (configFile) {
                    const content = await downloadFile(configFile.id);
                    configData = JSON.parse(content);
                    console.log('✅ Конфигурация загружена из Google Drive');
                    
                    // Обновляем статусы
                    updateSystemStatus();
                    
                } else {
                    throw new Error('Файл конфигурации не найден в Google Drive');
                }
            } catch (error) {
                console.error('❌ Ошибка загрузки конфигурации:', error);
                throw error;
            }
        }

        // ========== АУТЕНТИФИКАЦИЯ ==========
        async function checkSession() {
            const session = localStorage.getItem('e_genius_system_session');
            
            if (session) {
                try {
                    const userData = JSON.parse(session);
                    
                    // Проверяем срок действия сессии (24 часа)
                    if (Date.now() - userData.timestamp < 24 * 60 * 60 * 1000) {
                        currentUser = userData;
                        showMainApp();
                        loadUserData();
                        return;
                    }
                } catch (e) {
                    // Сессия повреждена
                    console.log('Сессия повреждена');
                }
            }
            
            // Показываем экран авторизации
            showAuthScreen();
        }

        async function authenticate(username, password) {
            // Очищаем пробелы
            username = username.trim().toLowerCase();
            
            // Гость
            if (username === 'guest') {
                return {
                    id: 'guest_' + Date.now(),
                    username: 'Гость',
                    role: 'guest',
                    timestamp: Date.now()
                };
            }
            
            // Проверяем конфигурацию
            if (!configData) {
                throw new Error('Конфигурация не загружена');
            }
            
            // Администратор
            if (username === 'admin' && password === configData.PASSWORD_ADMIN) {
                return {
                    id: 'admin_1',
                    username: 'Администратор',
                    role: 'admin',
                    timestamp: Date.now()
                };
            }
            
            // Платон
            if (username === 'platon' && password === configData.PASSWORD_PLATON) {
                return {
                    id: 'platon_1',
                    username: 'Платон Бердников',
                    role: 'platon',
                    timestamp: Date.now()
                };
            }
            
            // Проверяем пользователей из auth_users.json
            try {
                const authUsers = await loadJsonFile(CONFIG.FILES.AUTH_USERS);
                if (authUsers && authUsers.users) {
                    // Пробуем найти по user_id (число)
                    const userId = parseInt(username);
                    if (!isNaN(userId)) {
                        const user = authUsers.users.find(u => u.user_id === userId);
                        if (user) {
                            return {
                                id: user.user_id.toString(),
                                username: `Пользователь ${user.user_id}`,
                                role: user.user_type || 'user',
                                timestamp: Date.now()
                            };
                        }
                    }
                    
                    // Пробуем найти по имени пользователя
                    const userByName = authUsers.users.find(u => 
                        u.username && u.username.toLowerCase() === username
                    );
                    
                    if (userByName) {
                        return {
                            id: userByName.user_id.toString(),
                            username: userByName.username,
                            role: userByName.user_type || 'user',
                            timestamp: Date.now()
                        };
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
            
            throw new Error('Неверное имя пользователя или пароль');
        }

        // ========== РАБОТА С ДАННЫМИ ==========
        async function loadJsonFile(filename) {
            try {
                const file = await findFile(filename, folderId);
                if (file) {
                    const content = await downloadFile(file.id);
                    return JSON.parse(content);
                }
                return null;
            } catch (error) {
                console.error(`Ошибка загрузки файла ${filename}:`, error);
                return null;
            }
        }

        async function loadDashboardData() {
            try {
                // Загружаем все необходимые данные параллельно
                const [emailsData, pcData, authData, settingsData] = await Promise.all([
                    loadJsonFile(CONFIG.FILES.EMAILS),
                    loadJsonFile(CONFIG.FILES.PC_STATUS),
                    loadJsonFile(CONFIG.FILES.AUTH_USERS),
                    loadJsonFile(CONFIG.FILES.SETTINGS)
                ]);
                
                // Обновляем интерфейс
                updateDashboardCards(emailsData, pcData, authData);
                updateEmailsTable(emailsData);
                updatePcCards(pcData);
                updateBroadcastCounts(emailsData, authData);
                updatePlatonCount(authData);
                updateSettings(settingsData);
                
            } catch (error) {
                console.error('Ошибка загрузки данных дашборда:', error);
            }
        }

        function updateDashboardCards(emailsData, pcData, authData) {
            const cardsContainer = document.getElementById('dashboardCards');
            
            if (!cardsContainer) return;
            
            // Email статистика
            const emailsCount = emailsData?.emails?.length || 0;
            const uniqueEmailUsers = new Set(emailsData?.emails?.map(e => e.user_id) || []).size;
            
            // ПК статистика
            const pcsCount = Array.isArray(pcData) ? pcData.length : 0;
            const onlinePcs = Array.isArray(pcData) ? 
                pcData.filter(pc => {
                    try {
                        const lastSeen = new Date(pc.last_seen || '2000-01-01');
                        return (Date.now() - lastSeen.getTime()) < 5 * 60 * 1000; // 5 минут
                    } catch {
                        return false;
                    }
                }).length : 0;
            
            // Пользователи
            const usersCount = authData?.users?.length || 0;
            const adminCount = authData?.users?.filter(u => u.user_type === 'admin').length || 0;
            const platonCount = authData?.users?.filter(u => u.user_type === 'platon').length || 0;
            
            cardsContainer.innerHTML = `
                <div class="card-item">
                    <h3><i class="fas fa-users"></i> Пользователи</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: #4cc9f0;">${usersCount}</div>
                    <p>Админов: ${adminCount}, Платонов: ${platonCount}</p>
                </div>
                <div class="card-item">
                    <h3><i class="fas fa-envelope"></i> Email адреса</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: #06d6a0;">${emailsCount}</div>
                    <p>уникальных пользователей: ${uniqueEmailUsers}</p>
                </div>
                <div class="card-item">
                    <h3><i class="fas fa-desktop"></i> ПК в системе</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: ${onlinePcs > 0 ? '#06d6a0' : '#f72585'};">${onlinePcs}/${pcsCount}</div>
                    <p>активных</p>
                </div>
                <div class="card-item">
                    <h3><i class="fas fa-bolt"></i> Система</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: #7209b7;">2.0</div>
                    <p>2026-2028</p>
                </div>
            `;
        }

        function updateSystemStatus() {
            if (!configData) return;
            
            // Google Drive статус
            const driveStatus = document.getElementById('driveStatus');
            if (driveStatus) {
                driveStatus.innerHTML = `<span style="color: #06d6a0;">✅ Подключен</span><br>
                                       <small>Папка: ${CONFIG.FOLDER_NAME}</small>`;
            }
            
            // Telegram Bot статус
            const botStatus = document.getElementById('botStatus');
            if (botStatus) {
                const hasToken = configData.BOT_TOKEN && configData.BOT_TOKEN !== 'ВАШ_ТОКЕН_ТЕЛЕГРАМ_БОТА';
                botStatus.innerHTML = hasToken ? 
                    `<span style="color: #06d6a0;">✅ Настроен</span>` : 
                    `<span style="color: #f8961e;">⚠️ Требуется настройка</span>`;
            }
            
            // AI статус
            const aiStatus = document.getElementById('aiStatus');
            if (aiStatus) {
                const hasKey = configData.OPENROUTER_KEY && configData.OPENROUTER_KEY.includes('sk-or-v1-');
                aiStatus.innerHTML = hasKey ? 
                    `<span style="color: #06d6a0;">✅ Доступен</span>` : 
                    `<span style="color: #f8961e;">⚠️ Требуется ключ</span>`;
            }
        }

        function updateEmailsTable(emailsData) {
            const tableBody = document.getElementById('emailsTable');
            
            if (!tableBody) return;
            
            if (!emailsData?.emails || emailsData.emails.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #aaa; padding: 30px;">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Нет email адресов в базе данных
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Показываем последние 15 email
            const recentEmails = emailsData.emails.slice(-15).reverse();
            
            tableBody.innerHTML = recentEmails.map(email => `
                <tr>
                    <td>${email.email || 'Нет email'}</td>
                    <td>${email.user_id || 'Неизвестно'}</td>
                    <td>${email.added_date || 'Неизвестно'}</td>
                    <td>
                        <button class="btn btn-outline btn-small" onclick="deleteEmail('${email.email}')" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePcCards(pcData) {
            const cardsContainer = document.getElementById('pcCards');
            
            if (!cardsContainer) return;
            
            if (!Array.isArray(pcData) || pcData.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="card-item" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <i class="fas fa-desktop" style="font-size: 3rem; color: #aaa; margin-bottom: 20px;"></i>
                        <h3>Нет данных о ПК</h3>
                        <p>Файл pc_status.json не содержит данных о подключенных компьютерах</p>
                        <p style="color: #aaa; font-size: 0.9rem; margin-top: 10px;">
                            Запустите скрипт управления на целевых ПК для получения данных
                        </p>
                    </div>
                `;
                return;
            }
            
            // Сортируем по последнему времени подключения
            const sortedPcs = [...pcData].sort((a, b) => {
                const timeA = new Date(a.last_seen || 0).getTime();
                const timeB = new Date(b.last_seen || 0).getTime();
                return timeB - timeA;
            });
            
            cardsContainer.innerHTML = sortedPcs.map(pc => {
                let lastSeen;
                let isOnline = false;
                
                try {
                    lastSeen = new Date(pc.last_seen || '2000-01-01');
                    isOnline = (Date.now() - lastSeen.getTime()) < 5 * 60 * 1000; // 5 минут
                } catch {
                    lastSeen = new Date('2000-01-01');
                    isOnline = false;
                }
                
                const lastSeenText = isOnline ? 
                    `Сейчас онлайн` : 
                    `Был ${lastSeen.toLocaleDateString()} ${lastSeen.toLocaleTimeString()}`;
                
                return `
                    <div class="card-item">
                        <h3>${pc.hostname || 'Неизвестный ПК'}</h3>
                        <p><strong>ID:</strong> ${pc.pc_id || 'Нет'}</p>
                        <p><strong>Пользователь:</strong> ${pc.username || 'Неизвестно'}</p>
                        <p><strong>IP:</strong> ${pc.ip_address || 'Нет'}</p>
                        <p><strong>Статус:</strong> 
                            <span class="status-badge ${isOnline ? 'status-online' : 'status-offline'}">
                                ${isOnline ? '✅ Онлайн' : '❌ Оффлайн'}
                            </span>
                        </p>
                        <p><strong>Последняя активность:</strong> ${lastSeenText}</p>
                        ${isOnline && currentUser?.role === 'admin' ? `
                            <div style="margin-top: 15px; display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-small" style="background: rgba(67, 97, 238, 0.2); color: white;" onclick="sendPcCommand('${pc.pc_id}', 'screenshot')">
                                    <i class="fas fa-camera"></i> Скриншот
                                </button>
                                <button class="btn btn-small" style="background: rgba(247, 37, 133, 0.2); color: white;" onclick="sendPcCommand('${pc.pc_id}', 'shutdown')">
                                    <i class="fas fa-power-off"></i> Выключить
                                </button>
                                <button class="btn btn-small" style="background: rgba(6, 214, 160, 0.2); color: white;" onclick="sendPcCommand('${pc.pc_id}', 'restart')">
                                    <i class="fas fa-redo"></i> Перезагрузить
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateBroadcastCounts(emailsData, authData) {
            // Telegram пользователи
            const tgUsersCount = authData?.users?.length || 0;
            const tgCountElement = document.getElementById('tgUsersCount');
            if (tgCountElement) {
                tgCountElement.textContent = tgUsersCount;
            }
            
            // Email пользователи
            const emailUsersCount = emailsData?.emails?.length || 0;
            const emailCountElement = document.getElementById('emailUsersCount');
            if (emailCountElement) {
                emailCountElement.textContent = emailUsersCount;
            }
        }

        function updatePlatonCount(authData) {
            const platonCount = authData?.users?.filter(u => u.user_type === 'platon').length || 0;
            const platonCountElement = document.getElementById('platonUsersCount');
            if (platonCountElement) {
                platonCountElement.textContent = platonCount;
            }
        }

        function updateSettings(settingsData) {
            const autoReplyToggle = document.getElementById('autoReplyToggle');
            const autoReplyStatus = document.getElementById('autoReplyStatus');
            
            if (autoReplyToggle && autoReplyStatus) {
                const isEnabled = settingsData?.settings?.channel_auto_reply === "true";
                autoReplyToggle.checked = isEnabled;
                autoReplyStatus.textContent = isEnabled ? 'Вкл' : 'Выкл';
                autoReplyStatus.style.color = isEnabled ? '#06d6a0' : '#aaa';
            }
        }

        // ========== УПРАВЛЕНИЕ ИНТЕРФЕЙСОМ ==========
        function showLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showAuthScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Обновляем информацию о пользователе
            updateUserInfo();
            
            // Загружаем данные
            loadUserData();
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userRole').textContent = `Роль: ${getRoleName(currentUser.role)}`;
            document.getElementById('userGreeting').textContent = `Панель управления | ${currentUser.username}`;
            
            const avatarText = currentUser.username.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = avatarText;
            
            // Цвет аватара по роли
            const avatar = document.getElementById('userAvatar');
            switch(currentUser.role) {
                case 'admin':
                    avatar.style.background = 'linear-gradient(135deg, #f72585, #7209b7)';
                    break;
                case 'platon':
                    avatar.style.background = 'linear-gradient(135deg, #4cc9f0, #4361ee)';
                    break;
                default:
                    avatar.style.background = 'linear-gradient(135deg, #6c757d, #495057)';
            }
        }

        function getRoleName(role) {
            switch(role) {
                case 'admin': return 'Администратор';
                case 'platon': return 'Платон';
                case 'guest': return 'Гость';
                default: return 'Пользователь';
            }
        }

        async function loadUserData() {
            try {
                // Загружаем данные для дашборда
                await loadDashboardData();
                
                // Обновляем информацию о системе
                updateSystemInfo();
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
            }
        }

        function updateSystemInfo() {
            const systemInfo = document.getElementById('systemInfo');
            if (!systemInfo || !currentUser) return;
            
            const info = `
                <p><strong>Папка Google Drive:</strong> ${CONFIG.FOLDER_NAME}</p>
                <p><strong>Пользователь:</strong> ${currentUser.username}</p>
                <p><strong>Роль:</strong> ${getRoleName(currentUser.role)}</p>
                <p><strong>User ID:</strong> ${currentUser.id}</p>
                <p><strong>Текущее время:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>Версия системы:</strong> 2.0 (2026-2028)</p>
            `;
            
            systemInfo.innerHTML = info;
        }

        function showError(message) {
            alert(`❌ ${message}`);
        }

        function showSuccess(message) {
            alert(`✅ ${message}`);
        }

        // ========== ОБРАБОТЧИКИ СОБЫТИЙ ==========
        document.addEventListener('click', function(e) {
            // Навигация по табам
            if (e.target.classList.contains('nav-tab')) {
                const panelId = e.target.getAttribute('data-panel');
                
                // Обновляем активные табы
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                e.target.classList.add('active');
                
                // Показываем соответствующую панель
                document.querySelectorAll('.panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(`panel-${panelId}`).classList.add('active');
            }
        });

        // Кнопка входа
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username) {
                showError('Введите имя пользователя');
                return;
            }
            
            try {
                const user = await authenticate(username, password);
                currentUser = user;
                
                // Сохраняем сессию
                localStorage.setItem('e_genius_system_session', JSON.stringify(user));
                
                // Показываем основное приложение
                showMainApp();
                
            } catch (error) {
                showError(error.message);
            }
        });

        // Кнопка выхода
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('e_genius_system_session');
            currentUser = null;
            showAuthScreen();
        });

        // Обновление ПК
        document.getElementById('refreshPcsBtn').addEventListener('click', async () => {
            await loadUserData();
            showSuccess('Список ПК обновлен');
        });

        // Обновление email
        document.getElementById('refreshEmailsBtn').addEventListener('click', async () => {
            await loadUserData();
            showSuccess('Список email обновлен');
        });

        // ИИ-помощник
        document.getElementById('askAiBtn').addEventListener('click', askAIQuestion);
        document.getElementById('aiQuestion').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askAIQuestion();
        });

        document.getElementById('clearAiBtn').addEventListener('click', () => {
            document.getElementById('aiResponse').innerHTML = 
                '<p style="color: #aaa; text-align: center;">Ответ от ИИ появится здесь</p>';
            document.getElementById('aiQuestion').value = '';
        });

        async function askAIQuestion() {
            const question = document.getElementById('aiQuestion').value.trim();
            
            if (!question) {
                showError('Введите вопрос');
                return;
            }
            
            if (!configData?.OPENROUTER_KEY || configData.OPENROUTER_KEY === 'sk-or-v1-ваш_ключ_openrouter') {
                showError('Ключ OpenRouter не настроен в конфигурации');
                return;
            }
            
            const responseElement = document.getElementById('aiResponse');
            responseElement.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
            
            try {
                // Используем тот же API, что и Telegram бот
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${configData.OPENROUTER_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'http://localhost',
                        'X-Title': 'E-Genius AI System'
                    },
                    body: JSON.stringify({
                        model: "allenai/molmo-2-8b:free",
                        messages: [
                            {
                                "role": "system",
                                "content": "Ты полезный AI-ассистент E-Genius. Отвечай на русском языке кратко и по делу."
                            },
                            {
                                "role": "user",
                                "content": question
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    responseElement.innerHTML = `<p>${data.choices[0].message.content}</p>`;
                } else {
                    throw new Error('Не удалось получить ответ от ИИ');
                }
            } catch (error) {
                console.error('Ошибка запроса к ИИ:', error);
                responseElement.innerHTML = `<p style="color: #f72585;">❌ Ошибка: ${error.message}</p>`;
            }
        }

        // Отправка команд ПК
        window.sendPcCommand = async function(pcId, command) {
            if (!currentUser || currentUser.role !== 'admin') {
                showError('Только администратор может отправлять команды ПК');
                return;
            }
            
            try {
                // Загружаем текущие команды
                const commandsData = await loadJsonFile(CONFIG.FILES.PC_COMMANDS) || { commands: [] };
                
                // Добавляем новую команду
                const newCommand = {
                    id: 'cmd_' + Date.now(),
                    type: command,
                    pc_id: pcId,
                    user_id: currentUser.id,
                    created_at: new Date().toISOString(),
                    status: 'pending'
                };
                
                commandsData.commands.push(newCommand);
                
                // Сохраняем обратно в Google Drive
                await saveJsonFile(CONFIG.FILES.PC_COMMANDS, commandsData);
                
                showSuccess(`Команда "${command}" отправлена на ПК ${pcId}`);
                
                // Обновляем данные
                await loadUserData();
                
            } catch (error) {
                console.error('Ошибка отправки команды:', error);
                showError('Ошибка отправки команды');
            }
        };

        // Удаление email
        window.deleteEmail = async function(email) {
            if (!currentUser || currentUser.role !== 'admin') {
                showError('Только администратор может удалять email');
                return;
            }
            
            if (!confirm(`Удалить email ${email}?`)) return;
            
            try {
                const emailsData = await loadJsonFile(CONFIG.FILES.EMAILS) || { emails: [] };
                
                // Фильтруем email
                const initialCount = emailsData.emails.length;
                emailsData.emails = emailsData.emails.filter(e => e.email !== email);
                
                if (emailsData.emails.length < initialCount) {
                    await saveJsonFile(CONFIG.FILES.EMAILS, emailsData);
                    showSuccess(`Email ${email} удален`);
                    await loadUserData();
                } else {
                    showError('Email не найден');
                }
            } catch (error) {
                console.error('Ошибка удаления email:', error);
                showError('Ошибка удаления email');
            }
        };

        // ========== GOOGLE DRIVE ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        async function findOrCreateFolder(folderName) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                if (response.result.files.length > 0) {
                    return response.result.files[0];
                }
                
                // Создаем новую папку
                const folder = await gapi.client.drive.files.create({
                    resource: {
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder'
                    },
                    fields: 'id'
                });
                
                return folder.result;
            } catch (error) {
                console.error('Ошибка поиска/создания папки:', error);
                throw error;
            }
        }

        async function findFile(filename, parentId) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${filename}' and '${parentId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                return response.result.files[0] || null;
            } catch (error) {
                console.error('Ошибка поиска файла:', error);
                return null;
            }
        }

        async function downloadFile(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                return response.body;
            } catch (error) {
                console.error('Ошибка загрузки файла:', error);
                throw error;
            }
        }

        async function saveJsonFile(filename, data) {
            try {
                const existingFile = await findFile(filename, folderId);
                const content = JSON.stringify(data, null, 2);
                
                const metadata = {
                    name: filename,
                    mimeType: 'application/json'
                };
                
                if (existingFile) {
                    // Обновляем существующий файл
                    await gapi.client.drive.files.update({
                        fileId: existingFile.id,
                        uploadType: 'media',
                        media: {
                            mimeType: 'application/json',
                            body: content
                        }
                    });
                } else {
                    // Создаем новый файл
                    metadata.parents = [folderId];
                    await gapi.client.drive.files.create({
                        resource: metadata,
                        uploadType: 'media',
                        media: {
                            mimeType: 'application/json',
                            body: content
                        }
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Ошибка сохранения файла:', error);
                throw error;
            }
        }
    </script>
</body>
</html>