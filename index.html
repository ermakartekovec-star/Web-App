<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå –ö–û–°–ú–ò–ß–ï–°–ö–ê–Ø –ò–ú–ü–ï–†–ò–Ø | Telegram MMO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #0f0f23);
            --tg-text: var(--tg-theme-text-color, #00ff00);
            --tg-accent: var(--tg-theme-button-color, #8a2be2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background: var(--tg-bg);
            color: var(--tg-text);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(100, 0, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 200, 0.1) 0%, transparent 20%);
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
            position: relative;
        }
        
        .hud {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 20, 40, 0.7);
            border-radius: 10px;
            border: 1px solid #00aaff;
        }
        
        .hud-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 40, 80, 0.5);
            border-radius: 8px;
            border: 1px solid #0088cc;
        }
        
        .resource-value {
            font-size: 18px;
            font-weight: bold;
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 15px;
            overflow-x: auto;
            gap: 5px;
        }
        
        .tab {
            padding: 10px 15px;
            background: rgba(0, 30, 60, 0.6);
            border: 1px solid #0055aa;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: var(--tg-accent);
            border-color: #ff00ff;
            box-shadow: 0 0 15px var(--tg-accent);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .galaxy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .planet {
            background: linear-gradient(135deg, #1a1a3a, #0a0a2a);
            border: 2px solid #4444aa;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .planet::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, transparent 30%, rgba(255,255,255,0.1) 70%);
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .planet:hover::before {
            opacity: 1;
        }
        
        .planet.owned {
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .planet.enemy {
            border-color: #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }
        
        .planet-level {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .button {
            background: linear-gradient(135deg, var(--tg-accent), #6a11cb);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .upgrade-item {
            background: rgba(0, 20, 40, 0.7);
            border: 1px solid #0088cc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rankings {
            background: rgba(0, 10, 30, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
        }
        
        .ranking-item.you {
            background: rgba(0, 100, 255, 0.2);
            border-left: 4px solid #00ff00;
        }
        
        .battle-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 20px 0;
            padding: 10px;
            background: rgba(0, 0, 30, 0.7);
            border-radius: 10px;
        }
        
        .cell {
            aspect-ratio: 1;
            background: rgba(0, 50, 100, 0.5);
            border: 1px solid #00aaff;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .cell.ship {
            background: radial-gradient(circle, #00ff00 30%, transparent 70%);
            box-shadow: 0 0 10px #00ff00;
        }
        
        .cell.enemy {
            background: radial-gradient(circle, #ff0000 30%, transparent 70%);
            box-shadow: 0 0 10px #ff0000;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 40, 80, 0.95);
            border: 2px solid #00ffcc;
            border-radius: 10px;
            padding: 15px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.5s;
            max-width: 300px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--tg-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .progress-bar {
            width: 80%;
            height: 20px;
            background: rgba(0, 50, 100, 0.5);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffcc, #0088ff);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
    <div class="preloader" id="preloader">
        <h1 style="color: #00ffcc; margin-bottom: 20px;">üåå –ö–û–°–ú–ò–ß–ï–°–ö–ê–Ø –ò–ú–ü–ï–†–ò–Ø</h1>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–ª–µ–Ω–Ω–æ–π...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="container" id="gameContainer" style="display: none;">
        <!-- –•–ê–ë -->
        <div class="hud">
            <div class="hud-item">
                <div>‚ö° –≠–ù–ï–†–ì–ò–Ø</div>
                <div class="resource-value" id="energy">0</div>
            </div>
            <div class="hud-item">
                <div>üîÆ –ú–ê–¢–ï–†–ò–Ø</div>
                <div class="resource-value" id="matter">0</div>
            </div>
            <div class="hud-item">
                <div>üíé –ö–†–ò–°–¢–ê–õ–õ–´</div>
                <div class="resource-value" id="crystals">0</div>
            </div>
            <div class="hud-item">
                <div>üèÜ –û–ß–ö–ò</div>
                <div class="resource-value" id="score">0</div>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('galaxy')">üåå –ì–ê–õ–ê–ö–¢–ò–ö–ê</div>
            <div class="tab" onclick="switchTab('fleet')">üöÄ –§–õ–û–¢</div>
            <div class="tab" onclick="switchTab('tech')">üî¨ –¢–ï–•–ù–û–õ–û–ì–ò–ò</div>
            <div class="tab" onclick="switchTab('battle')">‚öîÔ∏è –ë–ò–¢–í–ê</div>
            <div class="tab" onclick="switchTab('rankings')">üèÜ –†–ï–ô–¢–ò–ù–ì</div>
            <div class="tab" onclick="switchTab('alliance')">ü§ù –ê–õ–¨–Ø–ù–°</div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
        <div id="tabContent">
            <!-- –ì–ê–õ–ê–ö–¢–ò–ö–ê -->
            <div class="tab-content active" id="galaxyTab">
                <h2 style="color: #00ffcc; margin-bottom: 15px;">üåå –ì–ê–õ–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –ö–ê–†–¢–ê</h2>
                <button class="button pulse" onclick="collectAllResources()">‚ö° –°–û–ë–†–ê–¢–¨ –†–ï–°–£–†–°–´</button>
                <div class="galaxy-grid" id="galaxyGrid"></div>
            </div>
            
            <!-- –§–õ–û–¢ -->
            <div class="tab-content" id="fleetTab">
                <h2 style="color: #00ffcc; margin-bottom: 15px;">üöÄ –í–ê–® –§–õ–û–¢</h2>
                <div id="fleetInfo"></div>
                <button class="button" onclick="buildShip('fighter')">üõ∏ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å (100 —ç–Ω–µ—Ä–≥–∏–∏)</button>
                <button class="button" onclick="buildShip('cruiser')">üöÄ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ö—Ä–µ–π—Å–µ—Ä (500 —ç–Ω–µ—Ä–≥–∏–∏)</button>
                <button class="button" onclick="buildShip('battleship')">üõ∞Ô∏è –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –õ–∏–Ω–∫–æ—Ä (2000 —ç–Ω–µ—Ä–≥–∏–∏)</button>
            </div>
            
            <!-- –¢–ï–•–ù–û–õ–û–ì–ò–ò -->
            <div class="tab-content" id="techTab">
                <h2 style="color: #00ffcc; margin-bottom: 15px;">üî¨ –î–†–ï–í–û –¢–ï–•–ù–û–õ–û–ì–ò–ô</h2>
                <div id="techTree"></div>
            </div>
            
            <!-- –ë–ò–¢–í–ê -->
            <div class="tab-content" id="battleTab">
                <h2 style="color: #00ffcc; margin-bottom: 15px;">‚öîÔ∏è –¢–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –ë–ò–¢–í–ê</h2>
                <div>–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: <span id="enemyName">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
                <div class="battle-grid" id="battleGrid"></div>
                <button class="button pulse" onclick="startBattle()">üéØ –ù–ê–ß–ê–¢–¨ –ë–ò–¢–í–£</button>
                <div id="battleLog" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <!-- –†–ï–ô–¢–ò–ù–ì -->
            <div class="tab-content" id="rankingsTab">
                <h2 style="color: #00ffcc; margin-bottom: 15px;">üèÜ –ì–õ–û–ë–ê–õ–¨–ù–´–ô –†–ï–ô–¢–ò–ù–ì</h2>
                <div class="rankings" id="rankingsList"></div>
                <button class="button" onclick="saveToCloud()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –í –û–ë–õ–ê–ö–û</button>
                <button class="button" onclick="loadFromCloud()">üîÑ –ó–ê–ì–†–£–ó–ò–¢–¨ –ò–ó –û–ë–õ–ê–ö–ê</button>
            </div>
            
            <!-- –ê–õ–¨–Ø–ù–° -->
            <div class="tab-content" id="allianceTab">
                <h2 style="color: #00ffcc; margin-bottom: 15px;">ü§ù –ö–û–°–ú–ò–ß–ï–°–ö–ò–ï –ê–õ–¨–Ø–ù–°–´</h2>
                <div id="allianceInfo"></div>
                <button class="button" onclick="createAlliance()">‚ú® –°–û–ó–î–ê–¢–¨ –ê–õ–¨–Ø–ù–° (1000 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤)</button>
                <button class="button" onclick="joinAlliance()">‚ûï –í–°–¢–£–ü–ò–¢–¨ –í –ê–õ–¨–Ø–ù–°</button>
            </div>
        </div>
    </div>

    <script>
        // ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================
        const GOOGLE_DRIVE_CONFIG = {
            CLIENT_ID: 'YOUR_CLIENT_ID', // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π Client ID
            API_KEY: 'YOUR_API_KEY',     // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π API Key
            DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            FOLDER_NAME: 'CosmicEmpire_GameData',
            FILE_NAME: 'cosmic_empire_data.json'
        };

        // ================= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =================
        let gameData = {
            players: {},           // –î–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            alliances: {},         // –ê–ª—å—è–Ω—Å—ã
            galaxy: [],           // –ü–ª–∞–Ω–µ—Ç—ã –≥–∞–ª–∞–∫—Ç–∏–∫–∏
            lastUpdate: Date.now()
        };
        
        let currentPlayer = {
            id: '',
            name: '',
            resources: {
                energy: 100,
                matter: 50,
                crystals: 10,
                score: 0
            },
            fleet: {
                fighters: 5,
                cruisers: 0,
                battleships: 0
            },
            technologies: [],
            planets: [],
            alliance: null,
            lastBattle: 0
        };
        
        let gapiInited = false;
        let gisInited = false;
        let authToken = null;

        // ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ =================
        document.addEventListener('DOMContentLoaded', async () => {
            updateProgress(10);
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∏–≥—Ä–æ–∫–∞ –∏–∑ Telegram –∏–ª–∏ —Å–ª—É—á–∞–π–Ω—ã–π
            if (window.Telegram && Telegram.WebApp.initDataUnsafe.user) {
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                currentPlayer.id = `tg_${tgUser.id}`;
                currentPlayer.name = tgUser.first_name || `–ö–æ—Å–º–æ–Ω–∞–≤—Ç_${Math.floor(Math.random() * 1000)}`;
            } else {
                currentPlayer.id = `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                currentPlayer.name = `–ò–≥—Ä–æ–∫_${Math.floor(Math.random() * 10000)}`;
            }
            
            updateProgress(30);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∞–ª–∞–∫—Ç–∏–∫–∏
            initializeGalaxy();
            updateProgress(50);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–∞—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            await initGoogleDrive();
            updateProgress(80);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –∏–≥—Ä–æ–∫–∞
            loadPlayerData();
            updateProgress(100);
            
            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤—ã—Ö —Ü–∏–∫–ª–æ–≤
            setTimeout(() => {
                document.getElementById('preloader').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'block';
                startGameLoops();
            }, 500);
        });

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // ================= GOOGLE DRIVE API =================
        async function initGoogleDrive() {
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ Google API
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load Google API'));
                    document.head.appendChild(script);
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è gapi
                await new Promise((resolve) => {
                    gapi.load('client', async () => {
                        try {
                            await gapi.client.init({
                                apiKey: GOOGLE_DRIVE_CONFIG.API_KEY,
                                discoveryDocs: GOOGLE_DRIVE_CONFIG.DISCOVERY_DOCS,
                            });
                            gapiInited = true;
                            console.log('Google API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Google API:', error);
                        }
                        resolve();
                    });
                });
                
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                await handleAuthClick();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Google Drive:', error);
                showNotification('‚ö†Ô∏è –û–±–ª–∞–∫–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.');
            }
        }

        async function handleAuthClick() {
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
                scope: GOOGLE_DRIVE_CONFIG.SCOPES,
                callback: (response) => {
                    if (response.error) {
                        console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', response);
                        return;
                    }
                    authToken = response.access_token;
                    gisInited = true;
                    console.log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                    loadGameDataFromDrive();
                },
            });
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        async function ensureGameFolder() {
            try {
                // –ü–æ–∏—Å–∫ –ø–∞–ø–∫–∏
                const response = await gapi.client.drive.files.list({
                    q: `name='${GOOGLE_DRIVE_CONFIG.FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)'
                });
                
                let folderId;
                if (response.result.files.length > 0) {
                    folderId = response.result.files[0].id;
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏
                    const folderMetadata = {
                        name: GOOGLE_DRIVE_CONFIG.FOLDER_NAME,
                        mimeType: 'application/vnd.google-apps.folder'
                    };
                    
                    const folderResponse = await gapi.client.drive.files.create({
                        resource: folderMetadata,
                        fields: 'id'
                    });
                    
                    folderId = folderResponse.result.id;
                    console.log('–ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:', folderId);
                }
                
                return folderId;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏:', error);
                throw error;
            }
        }

        async function saveToCloud() {
            try {
                if (!gapiInited || !gisInited) {
                    throw new Error('Google Drive –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }
                
                showNotification('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ...');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ –æ–±—â–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                gameData.players[currentPlayer.id] = {
                    ...currentPlayer,
                    lastSave: Date.now()
                };
                
                // –ò—â–µ–º —Ñ–∞–π–ª
                const folderId = await ensureGameFolder();
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${GOOGLE_DRIVE_CONFIG.FILE_NAME}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)'
                });
                
                let fileId;
                if (searchResponse.result.files.length > 0) {
                    fileId = searchResponse.result.files[0].id;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
                    await gapi.client.drive.files.update({
                        fileId: fileId,
                        media: {
                            mimeType: 'application/json',
                            body: JSON.stringify(gameData, null, 2)
                        }
                    });
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
                    const fileMetadata = {
                        name: GOOGLE_DRIVE_CONFIG.FILE_NAME,
                        parents: [folderId]
                    };
                    
                    const createResponse = await gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: 'application/json',
                            body: JSON.stringify(gameData, null, 2)
                        },
                        fields: 'id'
                    });
                    
                    fileId = createResponse.result.id;
                }
                
                showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ!');
                updateRankings();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ');
            }
        }

        async function loadFromCloud() {
            try {
                if (!gapiInited || !gisInited) {
                    throw new Error('Google Drive –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                }
                
                showNotification('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞...');
                
                const folderId = await ensureGameFolder();
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${GOOGLE_DRIVE_CONFIG.FILE_NAME}' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name)'
                });
                
                if (searchResponse.result.files.length === 0) {
                    showNotification('üìÅ –§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                const fileId = searchResponse.result.files[0].id;
                const fileResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                gameData = fileResponse.result;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (gameData.players[currentPlayer.id]) {
                    const savedData = gameData.players[currentPlayer.id];
                    currentPlayer = {
                        ...currentPlayer,
                        ...savedData,
                        id: currentPlayer.id, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π ID
                        name: currentPlayer.name // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∏–º—è
                    };
                    savePlayerData();
                }
                
                showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞!');
                updateUI();
                updateRankings();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞');
            }
        }

        async function loadGameDataFromDrive() {
            try {
                await loadFromCloud();
            } catch (error) {
                console.log('–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≤—Å–µ–ª–µ–Ω–Ω—É—é...');
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
                gameData = {
                    players: {},
                    alliances: {},
                    galaxy: generateGalaxy(),
                    lastUpdate: Date.now()
                };
            }
        }

        // ================= –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê =================
        function initializeGalaxy() {
            if (!gameData.galaxy || gameData.galaxy.length === 0) {
                gameData.galaxy = generateGalaxy();
            }
            renderGalaxy();
        }

        function generateGalaxy() {
            const planets = [];
            const types = ['–õ–µ–¥—è–Ω–æ–π', '–ü—É—Å—Ç—ã–Ω–Ω—ã–π', '–û–∫–µ–∞–Ω–∏—á–µ—Å–∫–∏–π', '–í—É–ª–∫–∞–Ω–∏—á–µ—Å–∫–∏–π', '–ì–∞–∑–æ–≤—ã–π –≥–∏–≥–∞–Ω—Ç', '–¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π'];
            
            for (let i = 1; i <= 20; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const owner = Math.random() > 0.7 ? 'enemy' : 'neutral';
                const resources = {
                    energy: Math.floor(Math.random() * 1000) + 100,
                    matter: Math.floor(Math.random() * 500) + 50,
                    crystals: Math.floor(Math.random() * 50) + 5
                };
                
                planets.push({
                    id: i,
                    name: `${type} –º–∏—Ä #${i}`,
                    type: type,
                    level: Math.floor(Math.random() * 10) + 1,
                    resources: resources,
                    owner: owner,
                    lastCollected: 0
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–ª–∞–Ω–µ—Ç—É –∏–≥—Ä–æ–∫–∞
            planets[0] = {
                id: 0,
                name: 'üè† –î–æ–º–∞—à–Ω–∏–π –º–∏—Ä',
                type: '–†–æ–¥–Ω–æ–π',
                level: 1,
                resources: { energy: 1000, matter: 500, crystals: 100 },
                owner: 'player',
                lastCollected: Date.now()
            };
            
            return planets;
        }

        function renderGalaxy() {
            const grid = document.getElementById('galaxyGrid');
            grid.innerHTML = '';
            
            gameData.galaxy.forEach(planet => {
                const planetDiv = document.createElement('div');
                planetDiv.className = `planet ${planet.owner}`;
                planetDiv.innerHTML = `
                    <div class="planet-level">ü™ê</div>
                    <div><strong>${planet.name}</strong></div>
                    <div>–£—Ä. ${planet.level}</div>
                    <div>${planet.owner === 'player' ? '‚úÖ –í–∞—à–∞' : planet.owner === 'enemy' ? '‚ö†Ô∏è –í—Ä–∞–∂–µ—Å–∫–∞—è' : '‚ö™ –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è'}</div>
                `;
                
                planetDiv.onclick = () => interactWithPlanet(planet.id);
                grid.appendChild(planetDiv);
            });
        }

        function interactWithPlanet(planetId) {
            const planet = gameData.galaxy.find(p => p.id === planetId);
            
            if (planet.owner === 'player') {
                collectResources(planetId);
            } else if (planet.owner === 'neutral') {
                if (confirm(`–ó–∞—Ö–≤–∞—Ç–∏—Ç—å –ø–ª–∞–Ω–µ—Ç—É "${planet.name}"?`)) {
                    capturePlanet(planetId);
                }
            } else {
                if (confirm(`–ê—Ç–∞–∫–æ–≤–∞—Ç—å –≤—Ä–∞–∂–µ—Å–∫—É—é –ø–ª–∞–Ω–µ—Ç—É "${planet.name}"?`)) {
                    prepareBattle(planet);
                }
            }
        }

        function collectResources(planetId) {
            const planet = gameData.galaxy.find(p => p.id === planetId);
            const now = Date.now();
            const timePassed = Math.floor((now - planet.lastCollected) / 60000); // –º–∏–Ω—É—Ç—ã
            
            if (timePassed < 5) {
                showNotification(`‚è≥ –†–µ—Å—É—Ä—Å—ã –µ—â–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å! –ñ–¥–∏—Ç–µ ${5 - timePassed} –º–∏–Ω.`);
                return;
            }
            
            currentPlayer.resources.energy += planet.resources.energy;
            currentPlayer.resources.matter += planet.resources.matter;
            currentPlayer.resources.crystals += Math.floor(planet.resources.crystals * 0.1);
            planet.lastCollected = now;
            
            showNotification(`üì¶ –°–æ–±—Ä–∞–Ω–æ —Å ${planet.name}: +${planet.resources.energy}‚ö° +${planet.resources.matter}üîÆ`);
            updateUI();
            savePlayerData();
        }

        function collectAllResources() {
            const playerPlanets = gameData.galaxy.filter(p => p.owner === 'player');
            let total = { energy: 0, matter: 0, crystals: 0 };
            
            playerPlanets.forEach(planet => {
                const now = Date.now();
                const timePassed = Math.floor((now - planet.lastCollected) / 60000);
                
                if (timePassed >= 5) {
                    total.energy += planet.resources.energy;
                    total.matter += planet.resources.matter;
                    total.crystals += Math.floor(planet.resources.crystals * 0.1);
                    planet.lastCollected = now;
                }
            });
            
            if (total.energy > 0) {
                currentPlayer.resources.energy += total.energy;
                currentPlayer.resources.matter += total.matter;
                currentPlayer.resources.crystals += total.crystals;
                
                showNotification(`üì¶ –°–æ–±—Ä–∞–Ω–æ —Å–æ –≤—Å–µ—Ö –ø–ª–∞–Ω–µ—Ç: +${total.energy}‚ö° +${total.matter}üîÆ +${total.crystals}üíé`);
                updateUI();
                savePlayerData();
            } else {
                showNotification('‚è≥ –†–µ—Å—É—Ä—Å—ã –µ—â–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å!');
            }
        }

        function capturePlanet(planetId) {
            const planet = gameData.galaxy.find(p => p.id === planetId);
            
            if (currentPlayer.fleet.fighters < 3) {
                showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –∏—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—è');
                return;
            }
            
            // –†–∞—Å—Ö–æ–¥ —Ñ–ª–æ—Ç–∞
            const lostFighters = Math.max(1, Math.floor(Math.random() * 3));
            currentPlayer.fleet.fighters -= lostFighters;
            
            // –ó–∞—Ö–≤–∞—Ç –ø–ª–∞–Ω–µ—Ç—ã
            planet.owner = 'player';
            currentPlayer.planets.push(planetId);
            currentPlayer.resources.score += planet.level * 100;
            
            showNotification(`‚úÖ –ü–ª–∞–Ω–µ—Ç–∞ "${planet.name}" –∑–∞—Ö–≤–∞—á–µ–Ω–∞! –ü–æ—Ç–µ—Ä—è–Ω–æ: ${lostFighters} –∏—Å—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π`);
            updateUI();
            renderGalaxy();
            savePlayerData();
        }

        // ================= –ë–ò–¢–í–ê =================
        function prepareBattle(planet) {
            currentBattle = {
                enemy: planet,
                playerShips: [...Array(currentPlayer.fleet.fighters).fill('fighter')],
                enemyShips: [...Array(Math.floor(Math.random() * 5) + 3).fill('enemy')],
                grid: Array(25).fill(null),
                playerTurn: true
            };
            
            document.getElementById('enemyName').textContent = planet.name;
            renderBattleGrid();
            switchTab('battle');
        }

        function renderBattleGrid() {
            const grid = document.getElementById('battleGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                
                if (currentBattle.grid[i]) {
                    cell.className += ` ${currentBattle.grid[i]}`;
                }
                
                cell.onclick = () => makeMove(i);
                grid.appendChild(cell);
            }
        }

        function makeMove(index) {
            if (!currentBattle.playerTurn || currentBattle.grid[index]) return;
            
            // –ò–≥—Ä–æ–∫ —Å—Ç–∞–≤–∏—Ç –∫–æ—Ä–∞–±–ª—å
            if (currentBattle.playerShips.length > 0) {
                currentBattle.grid[index] = 'ship';
                currentBattle.playerShips.pop();
                
                // –•–æ–¥ –≤—Ä–∞–≥–∞
                currentBattle.playerTurn = false;
                setTimeout(enemyMove, 500);
            }
            
            renderBattleGrid();
            checkBattleEnd();
        }

        function enemyMove() {
            const emptyCells = currentBattle.grid
                .map((cell, index) => cell === null ? index : -1)
                .filter(index => index !== -1);
            
            if (emptyCells.length > 0 && currentBattle.enemyShips.length > 0) {
                const randomIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                currentBattle.grid[randomIndex] = 'enemy';
                currentBattle.enemyShips.pop();
            }
            
            currentBattle.playerTurn = true;
            renderBattleGrid();
            checkBattleEnd();
        }

        function checkBattleEnd() {
            if (currentBattle.playerShips.length === 0 && currentBattle.enemyShips.length === 0) {
                // –ü–æ–¥—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const playerShips = currentBattle.grid.filter(cell => cell === 'ship').length;
                const enemyShips = currentBattle.grid.filter(cell => cell === 'enemy').length;
                
                let message = '';
                if (playerShips > enemyShips) {
                    message = `üéâ –ü–û–ë–ï–î–ê! –í—ã –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –ø–ª–∞–Ω–µ—Ç—É!`;
                    currentBattle.enemy.owner = 'player';
                    currentPlayer.resources.score += 500;
                } else if (enemyShips > playerShips) {
                    message = `üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï! –í—Ä–∞–∂–µ—Å–∫–∞—è –ø–ª–∞–Ω–µ—Ç–∞ —É—Å—Ç–æ—è–ª–∞.`;
                    // –ü–æ—Ç–µ—Ä—è —Ñ–ª–æ—Ç–∞
                    currentPlayer.fleet.fighters = Math.max(0, currentPlayer.fleet.fighters - 2);
                } else {
                    message = `ü§ù –ù–ò–ß–¨–Ø! –ü–ª–∞–Ω–µ—Ç–∞ –æ—Å—Ç–∞–ª–∞—Å—å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–π.`;
                }
                
                showNotification(message);
                updateUI();
                savePlayerData();
            }
        }

        function startBattle() {
            if (!currentBattle) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤—Ä–∞–≥–∞
                const enemyPlanets = gameData.galaxy.filter(p => p.owner === 'enemy');
                if (enemyPlanets.length > 0) {
                    prepareBattle(enemyPlanets[Math.floor(Math.random() * enemyPlanets.length)]);
                } else {
                    showNotification('üéâ –í—Ä–∞–∂–µ—Å–∫–∏—Ö –ø–ª–∞–Ω–µ—Ç –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å!');
                }
            }
        }

        // ================= –ö–û–†–ê–ë–õ–ò –ò –¢–ï–•–ù–û–õ–û–ì–ò–ò =================
        function buildShip(type) {
            const costs = {
                fighter: { energy: 100, matter: 50 },
                cruiser: { energy: 500, matter: 200 },
                battleship: { energy: 2000, matter: 1000 }
            };
            
            const cost = costs[type];
            
            if (currentPlayer.resources.energy >= cost.energy && 
                currentPlayer.resources.matter >= cost.matter) {
                
                currentPlayer.resources.energy -= cost.energy;
                currentPlayer.resources.matter -= cost.matter;
                currentPlayer.fleet[type + 's']++;
                currentPlayer.resources.score += cost.energy / 10;
                
                showNotification(`‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω ${getShipName(type)}!`);
                updateUI();
                savePlayerData();
            } else {
                showNotification(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!`);
            }
        }

        function getShipName(type) {
            const names = {
                fighter: 'üõ∏ –ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å',
                cruiser: 'üöÄ –ö—Ä–µ–π—Å–µ—Ä',
                battleship: 'üõ∞Ô∏è –õ–∏–Ω–∫–æ—Ä'
            };
            return names[type] || type;
        }

        function renderTechTree() {
            const techs = [
                { id: 'mining', name: 'üìà –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–æ–±—ã—á–∞', cost: 100, description: '+20% –∫ –¥–æ–±—ã—á–µ —Ä–µ—Å—É—Ä—Å–æ–≤' },
                { id: 'fleet', name: 'üöÄ –£–ª—É—á—à–µ–Ω–∏–µ —Ñ–ª–æ—Ç–∞', cost: 500, description: '–ö–æ—Ä–∞–±–ª–∏ +10% –∫ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏' },
                { id: 'warp', name: 'üåÄ –í–∞—Ä–ø-–¥–≤–∏–≥–∞—Ç–µ–ª—å', cost: 1000, description: '–ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è' },
                { id: 'shield', name: 'üõ°Ô∏è –©–∏—Ç—ã –ø–ª–∞–Ω–µ—Ç—ã', cost: 2000, description: '–ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫' },
                { id: 'ai', name: 'ü§ñ –ë–æ–µ–≤–æ–π –ò–ò', cost: 5000, description: '–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–µ —Å—Ä–∞–∂–µ–Ω–∏—è' }
            ];
            
            const container = document.getElementById('techTree');
            container.innerHTML = '';
            
            techs.forEach(tech => {
                const hasTech = currentPlayer.technologies.includes(tech.id);
                const canAfford = currentPlayer.resources.crystals >= tech.cost;
                
                const div = document.createElement('div');
                div.className = 'upgrade-item';
                div.innerHTML = `
                    <div>
                        <strong>${tech.name}</strong><br>
                        <small>${tech.description}</small>
                    </div>
                    <div>
                        ${hasTech ? '‚úÖ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–æ' : 
                          `<button onclick="researchTech('${tech.id}', ${tech.cost})" 
                                   ${!canAfford ? 'disabled style="opacity:0.5"' : ''}
                                   class="button" style="padding: 5px 10px; font-size: 12px;">
                            üß™ –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å (${tech.cost}üíé)
                          </button>`}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function researchTech(techId, cost) {
            if (currentPlayer.resources.crystals >= cost && !currentPlayer.technologies.includes(techId)) {
                currentPlayer.resources.crystals -= cost;
                currentPlayer.technologies.push(techId);
                currentPlayer.resources.score += cost * 10;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
                applyTechEffect(techId);
                
                showNotification(`üî¨ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∞!`);
                updateUI();
                renderTechTree();
                savePlayerData();
            }
        }

        function applyTechEffect(techId) {
            switch(techId) {
                case 'mining':
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ–±—ã—á—É –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞–Ω–µ—Ç–∞—Ö
                    gameData.galaxy.forEach(p => {
                        if (p.owner === 'player') {
                            p.resources.energy = Math.floor(p.resources.energy * 1.2);
                            p.resources.matter = Math.floor(p.resources.matter * 1.2);
                        }
                    });
                    break;
                case 'fleet':
                    // –ë–æ–Ω—É—Å –∫ —Ñ–ª–æ—Ç—É —É–∂–µ —É—á—Ç–µ–Ω –≤ –ª–æ–≥–∏–∫–µ –±–æ—è
                    break;
            }
        }

        // ================= –†–ï–ô–¢–ò–ù–ì –ò –ê–õ–¨–Ø–ù–°–´ =================
        function updateRankings() {
            const rankingsDiv = document.getElementById('rankingsList');
            if (!rankingsDiv) return;
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ gameData
            const playersArray = Object.entries(gameData.players).map(([id, player]) => ({
                id,
                name: player.name,
                score: player.resources?.score || 0,
                planets: player.planets?.length || 0,
                lastActive: player.lastSave || 0
            }));
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ—á–∫–∞–º
            playersArray.sort((a, b) => b.score - a.score);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–æ–ø-50
            const topPlayers = playersArray.slice(0, 50);
            
            rankingsDiv.innerHTML = '';
            
            topPlayers.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = `ranking-item ${player.id === currentPlayer.id ? 'you' : ''}`;
                div.innerHTML = `
                    <div>
                        <strong>${index + 1}. ${player.name}</strong>
                        ${player.id === currentPlayer.id ? ' (–í—ã)' : ''}
                    </div>
                    <div>
                        üèÜ ${player.score} | ü™ê ${player.planets}
                    </div>
                `;
                rankingsDiv.appendChild(div);
            });
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç –≤ —Ç–æ–ø–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ
            if (!topPlayers.find(p => p.id === currentPlayer.id)) {
                const player = playersArray.find(p => p.id === currentPlayer.id);
                if (player) {
                    const div = document.createElement('div');
                    div.className = 'ranking-item you';
                    div.innerHTML = `
                        <div>
                            <strong>???. ${player.name} (–í—ã)</strong>
                        </div>
                        <div>
                            üèÜ ${player.score} | ü™ê ${player.planets}
                        </div>
                    `;
                    rankingsDiv.appendChild(div);
                }
            }
        }

        function createAlliance() {
            if (currentPlayer.resources.crystals < 1000) {
                showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤! –ù—É–∂–Ω–æ 1000üíé');
                return;
            }
            
            const allianceName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–ª—å—è–Ω—Å–∞:');
            if (!allianceName || allianceName.trim() === '') return;
            
            const allianceId = `alliance_${Date.now()}`;
            gameData.alliances[allianceId] = {
                id: allianceId,
                name: allianceName,
                creator: currentPlayer.id,
                members: [currentPlayer.id],
                score: 0,
                created: Date.now()
            };
            
            currentPlayer.alliance = allianceId;
            currentPlayer.resources.crystals -= 1000;
            currentPlayer.resources.score += 5000;
            
            showNotification(`‚úÖ –ê–ª—å—è–Ω—Å "${allianceName}" —Å–æ–∑–¥–∞–Ω!`);
            updateUI();
            savePlayerData();
            saveToCloud();
        }

        function joinAlliance() {
            const alliances = Object.values(gameData.alliances);
            if (alliances.length === 0) {
                showNotification('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–ª—å—è–Ω—Å–æ–≤');
                return;
            }
            
            const allianceList = alliances.map(a => `${a.name} (${a.members.length} –∏–≥—Ä–æ–∫–æ–≤)`).join('\n');
            const choice = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ –∞–ª—å—è–Ω—Å –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è:\n\n${allianceList}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞–ª—å—è–Ω—Å–∞:`);
            
            // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞
            const selectedAlliance = alliances[parseInt(choice) - 1];
            if (selectedAlliance) {
                selectedAlliance.members.push(currentPlayer.id);
                currentPlayer.alliance = selectedAlliance.id;
                showNotification(`‚úÖ –í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –∞–ª—å—è–Ω—Å "${selectedAlliance.name}"!`);
                savePlayerData();
                saveToCloud();
            }
        }

        // ================= –£–¢–ò–õ–ò–¢–´ =================
        function switchTab(tabName) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫
            if (tabName === 'rankings') {
                updateRankings();
            } else if (tabName === 'tech') {
                renderTechTree();
            } else if (tabName === 'fleet') {
                updateFleetInfo();
            } else if (tabName === 'alliance') {
                updateAllianceInfo();
            }
        }

        function updateUI() {
            document.getElementById('energy').textContent = Math.floor(currentPlayer.resources.energy);
            document.getElementById('matter').textContent = Math.floor(currentPlayer.resources.matter);
            document.getElementById('crystals').textContent = Math.floor(currentPlayer.resources.crystals);
            document.getElementById('score').textContent = Math.floor(currentPlayer.resources.score);
        }

        function updateFleetInfo() {
            const div = document.getElementById('fleetInfo');
            div.innerHTML = `
                <div class="upgrade-item">
                    <div>üõ∏ –ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</div>
                    <div><strong>${currentPlayer.fleet.fighters}</strong></div>
                </div>
                <div class="upgrade-item">
                    <div>üöÄ –ö—Ä–µ–π—Å–µ—Ä—ã</div>
                    <div><strong>${currentPlayer.fleet.cruisers}</strong></div>
                </div>
                <div class="upgrade-item">
                    <div>üõ∞Ô∏è –õ–∏–Ω–∫–æ—Ä—ã</div>
                    <div><strong>${currentPlayer.fleet.battleships}</strong></div>
                </div>
            `;
        }

        function updateAllianceInfo() {
            const div = document.getElementById('allianceInfo');
            
            if (currentPlayer.alliance && gameData.alliances[currentPlayer.alliance]) {
                const alliance = gameData.alliances[currentPlayer.alliance];
                div.innerHTML = `
                    <div class="upgrade-item">
                        <div><strong>${alliance.name}</strong></div>
                        <div>üë• ${alliance.members.length} –∏–≥—Ä–æ–∫–æ–≤</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</strong><br>
                        ${alliance.members.map(memberId => {
                            const player = gameData.players[memberId];
                            return player ? `‚Ä¢ ${player.name}` : '‚Ä¢ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–≥—Ä–æ–∫';
                        }).join('<br>')}
                    </div>
                `;
            } else {
                div.innerHTML = '<div class="upgrade-item">–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∞–ª—å—è–Ω—Å–µ</div>';
            }
        }

        function savePlayerData() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
            localStorage.setItem(`cosmic_empire_${currentPlayer.id}`, JSON.stringify(currentPlayer));
        }

        function loadPlayerData() {
            const saved = localStorage.getItem(`cosmic_empire_${currentPlayer.id}`);
            if (saved) {
                const loaded = JSON.parse(saved);
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏, —Å–æ—Ö—Ä–∞–Ω—è—è ID –∏ –∏–º—è
                currentPlayer = {
                    ...loaded,
                    id: currentPlayer.id,
                    name: currentPlayer.name
                };
                console.log('–î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage');
            }
            updateUI();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s reverse';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function startGameLoops() {
            // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(() => {
                if (currentPlayer.technologies.includes('mining')) {
                    currentPlayer.resources.energy += 10;
                    currentPlayer.resources.matter += 5;
                } else {
                    currentPlayer.resources.energy += 5;
                    currentPlayer.resources.matter += 2;
                }
                updateUI();
            }, 60000);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
            setInterval(() => {
                savePlayerData();
                if (gapiInited && gisInited) {
                    saveToCloud();
                }
            }, 120000);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
            setInterval(() => {
                updateRankings();
            }, 300000);
        }
    </script>
</body>
</html>